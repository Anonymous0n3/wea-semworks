@model List<WebApplication1.Models.Data.HelloDoc>
@using System.Globalization
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<WebApplication1.SharedResource> Localizer
@inject IConfiguration Configuration

@{
    ViewData["Title"] = "Dashboard";
    var currentLang = CultureInfo.CurrentUICulture.TwoLetterISOLanguageName;
    var returnUrl = Context.Request.Path + Context.Request.QueryString;
    var googleRedirectUri = Configuration["GOOGLE_REDIRECTURI"]; // URI registrované v Google Console
}

<div class="container mt-4">

    <!-- Jazykový přepínač -->
    <div class="d-flex justify-content-end mb-3">
        <form method="post" action="/set-language" class="d-inline">
            <input type="hidden" name="returnUrl" value="@returnUrl" />
            <select name="culture" class="form-select form-select-sm w-auto" onchange="this.form.submit()">
                <option value="cs" selected="@((currentLang == "cs") ? "selected" : null)">@Localizer["CJ"]</option>
                <option value="en" selected="@((currentLang == "en") ? "selected" : null)">@Localizer["AJ"]</option>
            </select>
        </form>
    </div>

    <hr class="my-4" />

    <h2>@Localizer["HelloCouchDBTitle"]</h2>

    @if (Model != null && Model.Any())
    {
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>@Localizer["TextHeader"]</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var doc in Model)
                {
                    <tr>
                        <td>@doc.text</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p><strong>@Localizer["DatabaseEmptyMessage"]</strong></p>
    }

    <form asp-controller="Hello" asp-action="Save" method="post" class="mt-3">
        <div class="form-group">
            <label for="text">@Localizer["EnterNewTextLabel"]</label>
            <input type="text" class="form-control" id="text" name="text" />
        </div>
        <button type="submit" class="btn btn-primary mt-2">@Localizer["SaveButton"]</button>
    </form>

    <hr class="my-4" />

    <!-- Přihlášení / Registrace -->
    <div id="authForms">
        <h3>@Localizer["Login"] / @Localizer["Register"]</h3>
        <div class="row">
            <div class="col-md-6">
                <h5>Login</h5>
                <form id="loginForm">
                    <div class="mb-2">
                        <input type="email" id="loginEmail" placeholder="Email" class="form-control" required />
                    </div>
                    <div class="mb-2">
                        <input type="password" id="loginPassword" placeholder="Password" class="form-control" required />
                    </div>
                    <div id="loginError" class="text-danger mb-2"></div>
                    <button type="submit" class="btn btn-success">@Localizer["Login"]</button>
                </form>

                <button id="googleLoginBtn" class="btn btn-danger mt-2">@Localizer["LoginGoogle"]</button>
            </div>

            <div class="col-md-6">
                <h5>@Localizer["Register"]</h5>
                <form id="registerForm">
                    <div class="mb-2">
                        <input type="text" id="regName" placeholder="Name" class="form-control" required />
                    </div>
                    <div class="mb-2">
                        <input type="email" id="regEmail" placeholder="Email" class="form-control" required />
                    </div>
                    <div class="mb-2">
                        <input type="password" id="regPassword" placeholder="Password" class="form-control" required />
                    </div>
                    <div id="registerError" class="text-danger mb-2"></div>
                    <button type="submit" class="btn btn-primary">@Localizer["Register"]</button>
                </form>
            </div>
        </div>
    </div>

    <div id="widgetContainer" class="mt-4"></div>
</div>

<script src="~/js/country-widget.js"></script>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const authForms = document.getElementById('authForms');
            const widgetContainer = document.getElementById('widgetContainer');
            const activeWidgets = new Map();
            const token = localStorage.getItem('jwtToken');

            // ---------------- JWT Expiration & Auto Logout ----------------
            function getJwtExpiration(token) {
                if (!token) return null;
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    return payload.exp ? payload.exp * 1000 : null; // převod na ms
                } catch (err) {
                    console.error("Invalid JWT token", err);
                    return null;
                }
            }

            function logoutUser() {
                localStorage.removeItem("jwtToken");
                // případně vyčistit stav widgetů
                activeWidgets.clear();
                widgetContainer.innerHTML = "";
                authForms.style.display = 'block';
                window.location.href = "/"; // přesměrování na login
            }

            function scheduleLogoutOnTokenExpiry() {
                const token = localStorage.getItem("jwtToken");
                const exp = getJwtExpiration(token);

                if (!exp) return;

                const now = Date.now();
                const timeout = exp - now;

                if (timeout <= 0) {
                    logoutUser();
                } else {
                    setTimeout(logoutUser, timeout);
                }
            }

            scheduleLogoutOnTokenExpiry(); // spustit při načtení

            // ---------------- Inicializace ----------------
            if (token) {
                authForms.style.display = 'none';
                loadSavedWidgets();
            }

            // ---------------- Login ----------------
            document.getElementById("loginForm").addEventListener("submit", async function(e) {
                e.preventDefault();
                const email = document.getElementById("loginEmail").value;
                const password = document.getElementById("loginPassword").value;
                const loginError = document.getElementById("loginError");

                try {
                    const res = await fetch("/api/auth/login", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await res.json();
                    if (!res.ok) {
                        loginError.textContent = data?.message || "Login failed";
                        return;
                    }

                    localStorage.setItem("jwtToken", data.token);
                    scheduleLogoutOnTokenExpiry(); // naplánovat odhlášení
                    window.location.href = "/";
                } catch (err) {
                    console.error(err);
                    loginError.textContent = "Login failed";
                }
            });

            // ---------------- Register ----------------
            document.getElementById("registerForm").addEventListener("submit", async function(e) {
                e.preventDefault();
                const name = document.getElementById("regName").value;
                const email = document.getElementById("regEmail").value;
                const password = document.getElementById("regPassword").value;
                const registerError = document.getElementById("registerError");

                try {
                    const res = await fetch("/api/auth/register", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ name, email, password })
                    });
                    const data = await res.json();
                    if (!res.ok) {
                        registerError.textContent = data?.message || "Registration failed";
                        return;
                    }

                    alert("Registration successful! You can now login.");
                    document.getElementById("registerForm").reset();
                } catch (err) {
                    console.error(err);
                    registerError.textContent = "Registration failed";
                }
            });

            // ---------------- Google Login ----------------
            const googleBtn = document.getElementById("googleLoginBtn");
            googleBtn?.addEventListener("click", () => {
                const clientId = "@Configuration["GOOGLE_CLIENTID"]";
                const redirectUri = "@googleRedirectUri";
                const scope = encodeURIComponent("openid email profile");
                const authUrl = `https://accounts.google.com/o/oauth2/v2/auth` +
                    `?client_id=${clientId}` +
                    `&redirect_uri=${encodeURIComponent(redirectUri)}` +
                    `&response_type=code&scope=${scope}` +
                    `&access_type=offline&prompt=select_account`;

                window.location.href = authUrl;
            });

            // ---------------- Po návratu z Google OAuth ----------------
            const params = new URLSearchParams(window.location.search);
            const code = params.get("code");
            if (code) {
                (async () => {
                    try {
                        const res = await fetch("/api/auth/google/exchange", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ code })
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data?.message || "Google login failed");

                        localStorage.setItem("jwtToken", data.token);
                        scheduleLogoutOnTokenExpiry(); // naplánovat odhlášení
                        window.history.replaceState({}, document.title, window.location.pathname);
                        window.location.href = "/";
                    } catch (err) {
                        console.error("Google login failed:", err);
                        alert("Google login failed: " + err.message);
                    }
                })();
            }

            // ---------------- Widgety ----------------
            async function loadSavedWidgets() {
                try {
                    const res = await fetch("/api/auth/widgets", {
                        headers: { "Authorization": "Bearer " + localStorage.getItem("jwtToken") }
                    });
                    if (!res.ok) return;
                    const widgets = await res.json();
                    widgets.forEach(w => loadWidget(w.name, w.location));
                } catch (err) {
                    console.error("Failed to load widgets:", err);
                }
            }

            async function loadWidget(widgetName, location = '') {
                try {
                    const resp = await fetch(`/Widget/Load?name=${widgetName}&location=${encodeURIComponent(location)}`);
                    const html = await resp.text();

                    let wrapper = activeWidgets.get(widgetName);
                    const isNew = !wrapper;
                    if (!wrapper) {
                        wrapper = document.createElement('div');
                        wrapper.classList.add('widget-wrapper', 'mb-3', 'position-relative', 'p-2', 'border', 'rounded');
                        wrapper.dataset.widgetName = widgetName;
                        widgetContainer.appendChild(wrapper);
                        activeWidgets.set(widgetName, wrapper);
                    }

                    wrapper.dataset.location = location;
                    wrapper.innerHTML = html;
                    addCloseButton(wrapper, widgetName);

                    if (isNew) {
                        wrapper.style.opacity = "0";
                        wrapper.style.transition = "opacity 0.3s ease";
                        requestAnimationFrame(() => (wrapper.style.opacity = "1"));
                    }

                } catch (err) {
                    console.error("Failed to load widget", widgetName, err);
                }
            }

            function addCloseButton(wrapper, widgetName) {
                if (wrapper.querySelector('.close-widget-btn')) return;
                const btn = document.createElement('button');
                btn.textContent = '×';
                btn.classList.add('btn', 'btn-sm', 'btn-danger', 'close-widget-btn');
                btn.style.position = "absolute";
                btn.style.top = "5px";
                btn.style.right = "5px";
                btn.addEventListener('click', () => {
                    wrapper.remove();
                    activeWidgets.delete(widgetName);
                });
                wrapper.appendChild(btn);
            }
        });
    </script>
}