@model IReadOnlyList<string>

@{
    var baseCurrency = ViewData["BaseCurrency"] as string ?? "EUR";
    var quoteCurrency = ViewData["QuoteCurrency"] as string ?? "USD";
    var rate = (decimal)(ViewData["Rate"] ?? 0m);
    var volatility = (decimal)(ViewData["Volatility"] ?? 0m);
    var history = ViewData["History"] as List<(DateTime Date, decimal Rate)> ?? new();
    var orderedHistory = history.OrderBy(h => h.Date).ToList();
}

<div class="currency-widget card shadow-sm p-4 rounded-3 bg-light">
    <h3 class="mb-3 text-center">
        Kurz: @baseCurrency → @quoteCurrency
    </h3>

    <div class="current-rate text-center mb-4">
        <h4>Aktuální kurz</h4>
        <p class="fs-3 fw-bold text-primary">@rate</p>
        <small class="text-muted">
            Volatilita za poslední 3 dny: <strong id="cw-vola">@volatility&nbsp;%</strong>
        </small>
    </div>

    <hr />

    <!-- 📈 Graf vývoje kurzu (vždy vůči USD) -->
    <div class="chart-container mb-4">
        <canvas id="rateChart"></canvas>
    </div>

    <hr />

    <div class="history mt-3">
        <h5>Historie za poslední 3 dny</h5>
        <table class="table table-striped table-sm mt-2">
            <thead>
                <tr>
                    <th>Datum</th>
                    <th>Kurz</th>
                    <th>Změna oproti aktuálnímu</th>
                </tr>
            </thead>
            <tbody id="cw-last3">
                <tr><td colspan="3" class="text-muted">Načítám…</td></tr>
            </tbody>
        </table>
    </div>

    <hr />

    <div class="text-center mt-4">
        <form id="currencyForm" class="d-inline-block">
            <label for="baseCurrency" class="form-label me-2">Základní měna:</label>
            <select id="baseCurrency" name="baseCurrency" class="form-select d-inline-block w-auto me-3">
                @foreach (var c in Model)
                {
                    <option value="@c" selected="@(c == ViewBag.BaseCurrency)">@c</option>
                }
            </select>

            <label for="quoteCurrency" class="form-label me-2">Cílová měna:</label>
            <select id="quoteCurrency" name="quoteCurrency" class="form-select d-inline-block w-auto me-3">
                @foreach (var c in Model)
                {
                    <option value="@c" selected="@(c == ViewBag.QuoteCurrency)">@c</option>
                }
            </select>

            <button type="submit" class="btn btn-primary">Zobrazit aktuální kurz</button>
        </form>
        <div class="form-text mt-2">Graf historie je vždy vůči USD. Pro graf se používá <strong>cílová měna</strong>.</div>
    </div>
</div>

<style>
    .currency-widget { max-width: 650px; margin: 0 auto; }
    .chart-container { position: relative; height: 250px; width: 100%; }
</style>

@section Scripts {
    <!-- Chart.js z CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const $ = s => document.querySelector(s);
            const quoteSelect = $("#quoteCurrency");
            const tableBody = $("#cw-last3");
            const volaSpan = $("#cw-vola");

            let chart;

            function renderChart(labels, data, labelText) {
                const ctx = document.getElementById('rateChart').getContext('2d');
                if (chart) chart.destroy();
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: labelText,
                            data: data,
                            fill: false,
                            tension: 0.3,
                            borderWidth: 2,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: false, title: { display: true, text: 'Kurz' } },
                            x: { title: { display: true, text: 'Datum' } }
                        },
                        plugins: { legend: { display: true, position: 'bottom' } }
                    }
                });
            }

            function renderLast3(points, current) {
                tableBody.innerHTML = "";
                const last = points.slice(-3).reverse();

                if (last.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-muted">Žádná data</td></tr>';
                    volaSpan.textContent = '0 %';
                    return;
                }

                const max = Math.max(...last.map(p => p.rate));
                const min = Math.min(...last.map(p => p.rate));
                const vola = current ? ((max - min) / current * 100) : 0;
                volaSpan.textContent = (isFinite(vola) ? vola.toFixed(2) : '0') + ' %';

                last.forEach(p => {
                    const diffPct = current ? ((p.rate - current) / current * 100) : 0;
                    const cls = diffPct >= 0 ? 'text-success' : 'text-danger';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${p.date}</td>
                        <td>${p.rate}</td>
                        <td class="${cls}">${diffPct >= 0 ? '+' : ''}${diffPct.toFixed(2)} %</td>
                    `;
                    tableBody.appendChild(tr);
                });
            }

            async function loadHistory() {
                const code = (quoteSelect.value || 'USD').toUpperCase();
                tableBody.innerHTML = '<tr><td colspan="3" class="text-muted">Načítám…</td></tr>';

                try {
                    const r = await fetch(`/api/swop/history?code=${encodeURIComponent(code)}&period=week`, {
                        headers: { 'Accept': 'application/json' }
                    });
                    if (!r.ok) throw new Error(await r.text());
                    const points = await r.json();

                    if (!Array.isArray(points) || points.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="3" class="text-muted">Žádná data</td></tr>';
                        renderChart([], [], `Kurz ${code} → USD`);
                        volaSpan.textContent = '0 %';
                        return;
                    }

                    const labels = points.map(p => p.date);
                    const data = points.map(p => p.rate);
                    const current = data[data.length - 1];

                    renderChart(labels, data, `Kurz ${code} → USD`);
                    renderLast3(points, current);
                } catch (e) {
                    console.error(e);
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-danger">Chyba při načítání historie.</td></tr>';
                }
            }

            // init
            loadHistory().catch(() => {});
            quoteSelect.addEventListener('change', loadHistory);
        });
    </script>
}
