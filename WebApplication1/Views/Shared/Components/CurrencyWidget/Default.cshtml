@model List<WebApplication1.Views.Shared.Components.CurrencyWidget.Currency>

@{
    var baseCur = ViewData["BaseCurrency"]?.ToString() ?? "EUR";
    var quoteCur = ViewData["QuoteCurrency"]?.ToString() ?? "USD";
    var rate = (decimal)(ViewData["Rate"] ?? 0m);
    var vol = (decimal)(ViewData["Volatility"] ?? 0m);
    var history = ViewData["History"] as List<(DateTime Date, decimal Rate)> ?? new();
}

<div class="card shadow-sm" id="currencyWidget">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Měnový kurz</h5>
        <span>@baseCur → @quoteCur : <strong>@rate</strong></span>
    </div>

    <div class="card-body">
        <form id="currencyForm" class="mb-3">
            <div class="row g-2 align-items-center">
                <div class="col-md-4">
                    <select name="baseCurrency" class="form-select">
                        @foreach (var c in Model)
                        {
                            <option value="@c.Id" selected="@(c.Id == baseCur)">
                                @c.Id
                            </option>
                        }
                    </select>
                </div>

                <div class="col-md-4">
                    <select name="quoteCurrency" class="form-select">
                        @foreach (var c in Model)
                        {
                            <option value="@c.Id" selected="@(c.Id == quoteCur)">
                                @c.Id
                            </option>
                        }
                    </select>
                </div>

                <div class="col-md-4">
                    <button type="submit" class="btn btn-success w-100">Načíst</button>
                </div>
            </div>
        </form>

        <p class="mt-3 mb-3">
            📈 Volatilita (3 dny): <strong>@vol %</strong>
        </p>

        <canvas id="currencyChart" height="120"></canvas>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const history = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                    history.Select(h => new { timestamp = h.Date, rate = h.Rate })
            ));

    const ctx = document.getElementById('currencyChart');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: history.map(h => new Date(h.timestamp).toLocaleDateString()),
            datasets: [{
                label: '@baseCur → @quoteCur',
                data: history.map(h => h.rate),
                borderWidth: 2,
                borderColor: 'green',
                tension: 0.3
            }]
        },
        options: { scales: { y: { beginAtZero: false } } }
    });

        document.getElementById('currencyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const params = new URLSearchParams(new FormData(e.target));
            const res = await fetch(`/CurrencyWidget?${params}`);
            const html = await res.text();
            document.getElementById('currencyWidget').outerHTML = html;
        });
    </script>
}
